name: Pipeline

on:
    push:
        branches:
            - master
    workflow_dispatch:
        branches:
            - master

jobs:
    deploy:
        runs-on: ubuntu-latest
        permissions:
            contents: read

        steps:
            -   uses: actions/checkout@v4

            -   name: Install SSH key
                uses: shimataro/ssh-key-action@v2
                with:
                    key: ${{ secrets.DEPLOY_SSH_KEY }}
                    known_hosts: placeholder

            -   name: Put SSH known host
                run: |
                    ssh-keyscan -p ${{ secrets.DEPLOY_PORT }} -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

            -   name: Deploy
                run: make deploy
                env:
                    HOST: ${{ secrets.DEPLOY_HOST }}
                    PORT: ${{ secrets.DEPLOY_PORT }}
